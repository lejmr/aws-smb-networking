# Basis VPN setup

The goal of this lab is to have an direct access to all EC2 instances that are either public or private using SSH or Remote desktop. The main challenge of this lab is to build a virtual router representing a physical box normally installed in office in order to have a place where to terminate Amazon AWS VPNs.

Router is based on [VyOS](https://vyos.io/).

The Terraform is used in order to generate basic PPTP configuration for VyOS. The only downside of this whole setup is the dependency management inter modules and their parts. The timeline of setup process is:
- Build EC2 instance based on VyOS (hub/stub network)
- Build Customer and VPN gateway (app network)
- Build site-to-site VPN connection
- Configure IPsec on VyOS

The problem, however, is after step 1. the EC2 instance is already running and default configuration is applied. There are a few workarounds, but the simplest approach is actually used. "Configure IPsec on VyOS" is done manually from configuration generated by Terraform.


## Basic steps

### Build infrastructure

```
terraform init
terraform apply
```

VPN configuration takes a bit of time, so dont worry and wait a few minutes. Once everything is completed, go to Amazon AWS console in order to find public IP address of *vpn-gateway-central*.


### IPsec interconnection

Terraform is used for
```
cat ipsec.vyos.conf
```


In order to finish this section, login onto *vpn-gateway-central* using ssh.

```
ssh -l vyos IP
The authenticity of host 'IP (IP)' can't be established.
ECDSA key fingerprint is SHA256:XXXXXXXX.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'IP' (ECDSA) to the list of known hosts.
Welcome to VyOS

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.

vyos@vpn-gateway-central:~$
```

At this moment you should be on VyOS console, so enter configuration mode and enter the generated configuration.

```
configure

# Paste all you got from cat ipsec.vyos.conf

vyos@vpn-gateway-central# exit
exit
vyos@vpn-gateway-central:~$ show vpn ipsec status
IPSec Process Running PID: 2346

2 Active IPsec Tunnels

IPsec Interfaces :
        eth0    (10.1.0.100)
```

At this moment you should have both IPsec tunnels connected.


## Validation of setup

### Exloratory testig of Amazon AWS account
- Login to AWS console and make sure you are in the right region
- Enter VPC module
- Enter "Site-to-Site VPN Connections"
- Click on "Tunnel Details"

Both tunnels should be UP and with 2 BGP ROUTES installed. Subsequently, enter "Route templates" page in the VPC module.
- Click on Private or DMZ route table
- Click on tab "Routes"

10.1.0.0/24 and 192.168.0.0/24 networks should


## Client VPN

Default configuration holds username and password the same *test*. Feel free to connect.

Also install some EC2 instances to the subnets of application network then try to connect from local computer.


Enjoy!
